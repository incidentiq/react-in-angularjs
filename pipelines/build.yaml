name: react-in-angular

variables:
  packVer: 'init'

trigger:
  branches:
    include:
      - master
      - develop

stages:
  - stage: Build
    jobs:
      - job: 
        steps:
          - checkout: self

          - task: Npm@1
            inputs:
              command: 'ci'
         
          - script: |
              version=$(cat package.json | jq -r .version)
              echo "##vso[build.updatebuildnumber]$version"
              echo @incidentiq:registry=https://pkgs.dev.azure.com/incidentiq/IIQ/_packaging/iiq-artifacts/npm/registry/ > .npmrc
            displayName: set private registry

          - script: |
              npm version $(Build.BuildNumber)-beta.$[counter('$(Build.BuildNumber)', 1)]
            condition: eq(variables['Build.SourceBranchName'], 'develop')
            displayName: Update beta version

          - task: Npm@1
            inputs:
              command: 'custom'
              customCommand: 'run build'

          - task: npmAuthenticate@0
            inputs:
              workingFile: '.npmrc'
            displayName: npm authenticate

          - task: Npm@1
            inputs:
              command: 'custom'
              ${{ if eq(variables['Build.SourceBranchName'], 'master') }}:
                customCommand: 'publish --dryrun --registry https://pkgs.dev.azure.com/incidentiq/IIQ/_packaging/iiq-artifacts/npm/registry/'
              ${{ else }}:
                customCommand: 'publish --dryrun --tag beta --registry https://pkgs.dev.azure.com/incidentiq/IIQ/_packaging/iiq-artifacts/npm/registry/'
  